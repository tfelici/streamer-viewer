name: Build Windows Executable

on:
  workflow_call:
    outputs:
      artifact-name:
        description: "Name of the Windows artifact"
        value: "StreamerViewer-windows"
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Flask requests requests-toolbelt Pillow pyinstaller
        pip install pywebview pymediainfo
        # Install jaraco dependencies explicitly to fix pkg_resources issues
        pip install jaraco.text jaraco.functools jaraco.collections importlib-metadata

    - name: Create PyInstaller spec file with splash screen
      run: |
        python -c "
        import os
        spec_content = '''# -*- mode: python ; coding: utf-8 -*-
        # Windows desktop application with splash screen and webview
        
        block_cipher = None
        
        a = Analysis(
            ['main.py'],
            pathex=['.'],
            binaries=[],
            datas=[
                ('templates', 'templates'),
                ('static', 'static'),
                ('splash.png', '.'),
            ],
            hiddenimports=[
                'webview',
                'webview.platforms.winforms',
                'pymediainfo',
                'flask',
                'requests',
                'pyi_splash',
            ],
            hookspath=[],
            hooksconfig={},
            runtime_hooks=[],
            excludes=[
                'tkinter', 
                'matplotlib', 
                'numpy', 
                'scipy', 
                'pandas',
                'IPython',
                'jupyter',
                'notebook',
                'sphinx',
                'pytest',
                'setuptools',
                'PyQt5',
                'PySide2',
                'PySide6',
                'qtpy',
                'gi',
                'gtk',
                'wx',
                'kivy',
                'tornado',
                'django',
                'sqlalchemy',
                'psycopg2',
                'sqlite3',  # Often not needed for web-based apps
                'urllib3.packages.six',  # Can cause bloat
            ],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=block_cipher,
            noarchive=False,
        )

        pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)
        
        splash = Splash(
            'splash.png',
            binaries=a.binaries,
            datas=a.datas,
            text_pos=(10, 300),
            text_size=14,
            text_color='white',
            minify_script=True,
            always_on_top=True,
        )
        
        exe = EXE(
            pyz,
            a.scripts,
            splash,
            splash.binaries,
            a.binaries,
            a.zipfiles,
            a.datas,
            [],
            name='StreamerViewer',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=False,
            upx_exclude=[],
            runtime_tmpdir=None,
            console=False,
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
        )
        '''
        with open('StreamerViewer.spec', 'w') as f:
            f.write(spec_content)
        print('Windows spec file created successfully')
        "

    - name: Build executable with PyInstaller
      run: |
        pyinstaller StreamerViewer.spec --noconfirm --clean

    - name: Create artifacts directory
      run: |
        python -c "import os; os.makedirs('artifacts', exist_ok=True)"

    - name: Prepare Windows artifact
      run: |
        python -c "
        import shutil
        shutil.copy('dist/StreamerViewer.exe', 'artifacts/StreamerViewer-windows.exe')
        print('Windows executable copied to artifacts')
        "

    - name: List build output
      run: |
        python -c "
        import os
        print('Contents of artifacts directory:')
        try:
            for item in os.listdir('artifacts'):
                item_path = os.path.join('artifacts', item)
                size = os.path.getsize(item_path) if os.path.isfile(item_path) else 'DIR'
                print(f'  {item} ({size} bytes)' if size != 'DIR' else f'  {item}/ (DIR)')
        except Exception as e:
            print(f'  No artifacts directory or error: {e}')
        "

    - name: Upload Windows executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: StreamerViewer-windows
        path: artifacts/*
        retention-days: 90