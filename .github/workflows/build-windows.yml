name: Build Windows Executable

on:
  workflow_call:
    outputs:
      artifact-name:
        description: "Name of the Windows artifact"
        value: "StreamerViewer-windows"
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Flask requests requests-toolbelt Pillow pyinstaller
        pip install pywebview pymediainfo
        # Install jaraco dependencies explicitly to fix pkg_resources issues
        pip install jaraco.text jaraco.functools jaraco.collections importlib-metadata

    - name: Create application metadata for Windows
      run: |
        # Create a simple application manifest to help with Windows trust
        echo '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0">
          <assemblyIdentity
            version="1.0.0.0"
            processorArchitecture="*"
            name="StreamerViewer"
            type="win32"
          />
          <description>GPS Track and Video Viewer</description>
          <trustInfo xmlns="urn:schemas-microsoft-com:asm.v2">
            <security>
              <requestedPrivileges xmlns="urn:schemas-microsoft-com:asm.v3">
                <requestedExecutionLevel level="asInvoker" uiAccess="false"/>
              </requestedPrivileges>
            </security>
          </trustInfo>
          <compatibility xmlns="urn:schemas-microsoft-com:compatibility.v1">
            <application>
              <supportedOS Id="{e2011457-1546-43c5-a5fe-008deee3d3f0}"/>
              <supportedOS Id="{35138b9a-5d96-4fbd-8e2d-a2440225f93a}"/>
              <supportedOS Id="{4a2f28e3-53b9-4441-ba9c-d69d4a4a6e38}"/>
            </application>
          </compatibility>
        </assembly>' > StreamerViewer.manifest
        
        echo "Skipping version info file due to encoding complexity - focusing on code signing"

    - name: Create PyInstaller spec file with splash screen
      run: |
        python -c "
        import os
        spec_content = '''# -*- mode: python ; coding: utf-8 -*-
        # Windows desktop application with splash screen and webview
        
        import os
        
        block_cipher = None
        
        a = Analysis(
            ['main.py'],
            pathex=['.'],
            binaries=[],
            datas=[
                ('templates', 'templates'),
                ('static', 'static'),
                ('splash.png', '.'),
            ],
            hiddenimports=[
                'webview',
                'webview.platforms.winforms',
                'pymediainfo',
                'flask',
                'requests',
                'pyi_splash',
            ],
            hookspath=[],
            hooksconfig={},
            runtime_hooks=[],
            excludes=[
                'tkinter', 
                'matplotlib', 
                'numpy', 
                'scipy', 
                'pandas',
                'IPython',
                'jupyter',
                'notebook',
                'sphinx',
                'pytest',
                'setuptools',
                'PyQt5',
                'PySide2',
                'PySide6',
                'qtpy',
                'gi',
                'gtk',
                'wx',
                'kivy',
                'tornado',
                'django',
                'sqlalchemy',
                'psycopg2',
                'sqlite3',  # Often not needed for web-based apps
                'urllib3.packages.six',  # Can cause bloat
            ],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=block_cipher,
            noarchive=False,
        )

        pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)
        
        splash = Splash(
            'splash.png',
            binaries=a.binaries,
            datas=a.datas,
            text_pos=(10, 300),
            text_size=14,
            text_color='white',
            minify_script=True,
            always_on_top=True,
        )
        
        exe = EXE(
            pyz,
            a.scripts,
            splash,
            splash.binaries,
            a.binaries,
            a.zipfiles,
            a.datas,
            [],
            name='StreamerViewer',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=False,
            upx_exclude=[],
            runtime_tmpdir=None,
            console=False,
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
            icon='icon.ico' if os.path.exists('icon.ico') else None,
        )
        '''
        with open('StreamerViewer.spec', 'w') as f:
            f.write(spec_content)
        print('Windows spec file created successfully')
        "

    - name: Build executable with PyInstaller
      run: |
        pyinstaller StreamerViewer.spec --noconfirm --clean

    - name: Create self-signed certificate for code signing
      run: |
        # Create a self-signed certificate to reduce SmartScreen warnings
        $cert = New-SelfSignedCertificate -Type Custom -Subject "CN=Streamer Viewer" -KeyUsage DigitalSignature -FriendlyName "Streamer Viewer Code Signing" -CertStoreLocation "Cert:\CurrentUser\My" -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
        
        # Export the certificate
        $pwd = ConvertTo-SecureString -String "StreamerViewer2024!" -Force -AsPlainText
        Export-PfxCertificate -cert "Cert:\CurrentUser\My\$($cert.Thumbprint)" -FilePath "StreamerViewer.pfx" -Password $pwd
        
        echo "Certificate created with thumbprint: $($cert.Thumbprint)"

    - name: Sign the executable
      run: |
        # Sign the executable with our self-signed certificate
        $signtool = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
        
        # If the specific version doesn't exist, find the latest version
        if (!(Test-Path $signtool)) {
          $signtool = Get-ChildItem "${env:ProgramFiles(x86)}\Windows Kits\10\bin\*\x64\signtool.exe" | Sort-Object Name -Descending | Select-Object -First 1 -ExpandProperty FullName
        }
        
        if (Test-Path $signtool) {
          echo "Found signtool at: $signtool"
          
          # Sign the executable
          $signResult = & "$signtool" sign /f "StreamerViewer.pfx" /p "StreamerViewer2024!" /t http://timestamp.digicert.com /fd SHA256 /v "dist\StreamerViewer.exe"
          
          if ($LASTEXITCODE -eq 0) {
            echo "‚úÖ Executable signed successfully"
            
            # Verify signature (this will show warnings for self-signed certs, but that's expected)
            echo "üîç Verifying signature (trust warnings expected for self-signed certificates)..."
            & "$signtool" verify /pa /v "dist\StreamerViewer.exe" 2>&1 | Out-Host
            # Reset exit code - verification warnings are expected for self-signed certificates
            $LASTEXITCODE = 0
            echo "üìã Code signing completed - SmartScreen warnings should be reduced"
          } else {
            echo "‚ö†Ô∏è Code signing failed, but continuing build"
          }
        } else {
          echo "‚ö†Ô∏è signtool.exe not found, executable will remain unsigned"
          echo "This may trigger SmartScreen warnings on Windows"
        }

    - name: Create artifacts directory
      run: |
        python -c "import os; os.makedirs('artifacts', exist_ok=True)"

    - name: Prepare Windows artifact
      run: |
        python -c "
        import shutil
        shutil.copy('dist/StreamerViewer.exe', 'artifacts/StreamerViewer-windows.exe')
        print('Windows executable copied to artifacts')
        
        # Create installation instructions for Windows users
        instructions = '''# Windows Installation Instructions
        
        ## SmartScreen Warning (Expected)
        When you first run StreamerViewer.exe, Windows may show a SmartScreen warning:
        \"Windows protected your PC - Microsoft Defender SmartScreen prevented an unrecognized app from starting\"
        
        This is normal for unsigned executables. To run the application:
        
        1. Click \"More info\" on the SmartScreen dialog
        2. Click \"Run anyway\" at the bottom
        3. The application will start normally
        
        ## Why This Happens
        - This executable is not digitally signed with a commercial code signing certificate
        - Windows flags all unsigned executables as potentially unsafe
        - This is a security feature, not an indication of malware
        
        ## Alternative: Run from Source
        If you prefer not to use the executable:
        1. Install Python 3.12+
        2. pip install Flask requests requests-toolbelt Pillow pywebview pymediainfo
        3. Run: python main.py
        
        ## Virus Scanning
        The executable has been built automatically on GitHub Actions and can be scanned with any antivirus software.
        '''
        
        with open('artifacts/WINDOWS_INSTALLATION.md', 'w') as f:
            f.write(instructions)
        print('Windows installation instructions created')
        "

    - name: List build output
      run: |
        python -c "
        import os
        print('Contents of artifacts directory:')
        try:
            for item in os.listdir('artifacts'):
                item_path = os.path.join('artifacts', item)
                size = os.path.getsize(item_path) if os.path.isfile(item_path) else 'DIR'
                print(f'  {item} ({size} bytes)' if size != 'DIR' else f'  {item}/ (DIR)')
        except Exception as e:
            print(f'  No artifacts directory or error: {e}')
        "

    - name: Upload Windows executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: StreamerViewer-windows
        path: artifacts/*
        retention-days: 90