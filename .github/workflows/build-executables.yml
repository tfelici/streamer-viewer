name: Build Cross-Platform Executables

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  # Call platform-specific workflows
  build-windows:
    name: Build Windows
    uses: ./.github/workflows/build-windows.yml
    
  build-linux:
    name: Build Linux  
    uses: ./.github/workflows/build-linux.yml
    
  build-macos:
    name: Build macOS
    uses: ./.github/workflows/build-macos.yml

  create-release:
    name: Create Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    # Create releases for version tags OR main/develop branch pushes
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: List downloaded artifacts (Debug)
      run: |
        echo "Downloaded artifacts:"
        find release-artifacts -type f -ls

    - name: Get version and branch info
      id: get_version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "IS_TAG=true" >> $GITHUB_OUTPUT
          echo "BRANCH=" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == refs/heads/develop ]]; then
          echo "VERSION=latest-develop" >> $GITHUB_OUTPUT
          echo "IS_TAG=false" >> $GITHUB_OUTPUT
          echo "BRANCH=develop" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
          echo "VERSION=latest-main" >> $GITHUB_OUTPUT
          echo "IS_TAG=false" >> $GITHUB_OUTPUT
          echo "BRANCH=main" >> $GITHUB_OUTPUT
        fi

    - name: Delete existing branch release if it exists
      if: steps.get_version.outputs.IS_TAG == 'false'
      run: |
        # Delete existing release tag and release (will be recreated)
        gh release delete ${{ steps.get_version.outputs.VERSION }} --yes || echo "Release ${{ steps.get_version.outputs.VERSION }} does not exist"
        git tag -d ${{ steps.get_version.outputs.VERSION }} || echo "Tag ${{ steps.get_version.outputs.VERSION }} does not exist locally"
        git push --delete origin ${{ steps.get_version.outputs.VERSION }} || echo "Tag ${{ steps.get_version.outputs.VERSION }} does not exist on remote"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create/Update Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ steps.get_version.outputs.IS_TAG == 'true' && format('Streamer Viewer {0}', steps.get_version.outputs.VERSION) || steps.get_version.outputs.BRANCH == 'develop' && 'Latest Development Build (Develop Branch)' || 'Latest Stable Build (Main Branch)' }}
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        body: |
          ${{ steps.get_version.outputs.IS_TAG == 'true' && format('## Streamer Viewer {0}', steps.get_version.outputs.VERSION) || steps.get_version.outputs.BRANCH == 'develop' && 'üöß **Latest Development Build (Develop Branch)**' || 'üöÄ **Latest Stable Build (Main Branch)**' }}
          
          ${{ steps.get_version.outputs.BRANCH == 'develop' && '‚ö†Ô∏è **Warning**: This is a development build from the develop branch. It may contain experimental features and should be used with the develop branch of RPI Streamer.' || '' }}
          
          ### Branch Compatibility
          ${{ steps.get_version.outputs.BRANCH == 'develop' && '- üîß **Use with**: RPI Streamer develop branch' || steps.get_version.outputs.BRANCH == 'main' && '- ‚úÖ **Use with**: RPI Streamer main branch (stable)' || '- üì¶ **Stable release**: Compatible with tagged RPI Streamer versions' }}
          ${{ steps.get_version.outputs.BRANCH == 'develop' && '- üß™ **Status**: Experimental/Testing' || '- üèÜ **Status**: Production Ready' }}
          
          ### Quick Download Links
          - **[Windows](https://github.com/tfelici/streamer-viewer/releases/download/${{ steps.get_version.outputs.VERSION }}/StreamerViewer-windows.exe)** - Double-click to run
          - **[Linux](https://github.com/tfelici/streamer-viewer/releases/download/${{ steps.get_version.outputs.VERSION }}/StreamerViewer-linux)** - `chmod +x StreamerViewer-linux && ./StreamerViewer-linux`
          - **[macOS](https://github.com/tfelici/streamer-viewer/releases/download/${{ steps.get_version.outputs.VERSION }}/StreamerViewer-macos)** - `chmod +x StreamerViewer-macos && ./StreamerViewer-macos`
          
          ### For Automated Scripts
          ```bash
          # Download from this specific release
          wget https://github.com/tfelici/streamer-viewer/releases/download/${{ steps.get_version.outputs.VERSION }}/StreamerViewer-linux
          wget https://github.com/tfelici/streamer-viewer/releases/download/${{ steps.get_version.outputs.VERSION }}/StreamerViewer-windows.exe  
          wget https://github.com/tfelici/streamer-viewer/releases/download/${{ steps.get_version.outputs.VERSION }}/StreamerViewer-macos
          ```
          
          ### System Requirements
          - **Windows**: Windows 10 or later
          - **Linux**: Ubuntu 18.04+ or equivalent (browser-based, no additional GUI libraries needed)
          - **macOS**: macOS 10.15+ (Catalina or later, browser-based)
          
          **Built from**: ${{ steps.get_version.outputs.BRANCH == 'develop' && format('develop branch commit {0}', github.sha) || steps.get_version.outputs.BRANCH == 'main' && format('main branch commit {0}', github.sha) || 'tagged release' }}
          **Build date**: ${{ github.event.head_commit.timestamp }}
        files: release-artifacts/*/*
        draft: false
        prerelease: ${{ steps.get_version.outputs.IS_TAG == 'false' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
