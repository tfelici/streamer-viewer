name: Build Cross-Platform Executables

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  # Call platform-specific workflows
  build-windows:
    name: Build Windows
    uses: ./.github/workflows/build-windows.yml
    
  build-linux:
    name: Build Linux  
    uses: ./.github/workflows/build-linux.yml
    
  build-macos:
    name: Build macOS
    uses: ./.github/workflows/build-macos.yml

  create-release:
    name: Create Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: List downloaded artifacts (Debug)
      run: |
        echo "Downloaded artifacts:"
        find release-artifacts -type f -ls

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Streamer Viewer ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## Streamer Viewer ${{ steps.get_version.outputs.VERSION }}
          
          ### Downloads
          - **Windows**: Download `StreamerViewer-windows.exe` 
          - **Linux**: Download `StreamerViewer-linux` (make executable with `chmod +x`)
          - **macOS**: Download `StreamerViewer-macos` (make executable with `chmod +x`)
          
          ### Installation
          1. Download the appropriate file for your operating system
          2. For Linux: `chmod +x StreamerViewer-linux && ./StreamerViewer-linux`
          3. For Windows: Double-click `StreamerViewer-windows.exe`
          4. For macOS: `chmod +x StreamerViewer-macos && ./StreamerViewer-macos`
          
          ### System Requirements
          - **Windows**: Windows 10 or later
          - **Linux**: Ubuntu 18.04+ or equivalent (browser-based, no GUI libraries needed)
          - **macOS**: macOS 10.15+ (Catalina or later, browser-based)
          
          Built automatically with GitHub Actions.
        files: release-artifacts/*/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  commit-executables:
    name: Commit Executables for Installer Download
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    # Only commit on develop and main branches for installer use
    if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main') && always()
    
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: build-artifacts

    - name: Prepare executable directories for installer download
      run: |
        # Create platform-specific directories for installer download paths
        mkdir -p windows/dist
        mkdir -p linux/dist
        mkdir -p macos/dist

    - name: Copy executables to installer download locations
      run: |
        # Copy Windows executable
        if [ -f "build-artifacts/StreamerViewer-windows/StreamerViewer-windows.exe" ]; then
          cp "build-artifacts/StreamerViewer-windows/StreamerViewer-windows.exe" "windows/dist/StreamerViewer.exe"
          echo "‚úÖ Windows executable ready for installer download"
        elif [ -f "build-artifacts/StreamerViewer-windows/StreamerViewer.exe" ]; then
          cp "build-artifacts/StreamerViewer-windows/StreamerViewer.exe" "windows/dist/StreamerViewer.exe"
          echo "‚úÖ Windows executable ready for installer download (alt path)"
        else
          echo "‚ö†Ô∏è  Windows executable not found in artifacts"
        fi

        # Copy Linux executable  
        if [ -f "build-artifacts/StreamerViewer-linux/StreamerViewer-linux" ]; then
          cp "build-artifacts/StreamerViewer-linux/StreamerViewer-linux" "linux/dist/StreamerViewer"
          chmod +x "linux/dist/StreamerViewer"
          echo "‚úÖ Linux executable ready for installer download"
        elif [ -f "build-artifacts/StreamerViewer-linux/StreamerViewer" ]; then
          cp "build-artifacts/StreamerViewer-linux/StreamerViewer" "linux/dist/StreamerViewer"
          chmod +x "linux/dist/StreamerViewer"
          echo "‚úÖ Linux executable ready for installer download (alt path)"
        else
          echo "‚ö†Ô∏è  Linux executable not found in artifacts"
        fi

        # Copy macOS executable (single file, not app bundle)
        if [ -f "build-artifacts/StreamerViewer-macos/StreamerViewer-macos" ]; then
          cp "build-artifacts/StreamerViewer-macos/StreamerViewer-macos" "macos/dist/StreamerViewer"
          chmod +x "macos/dist/StreamerViewer"
          echo "‚úÖ macOS executable ready for installer download"
        else
          echo "‚ö†Ô∏è  macOS executable not found in artifacts"
        fi

    - name: Check for executable availability
      id: check_executables
      run: |
        # Check if executables exist for installer download
        executables_found=false
        
        if [ -f "windows/dist/StreamerViewer.exe" ]; then
          echo "‚úì Windows executable available for installer download"
          executables_found=true
        fi
        
        if [ -f "linux/dist/StreamerViewer" ]; then
          echo "‚úì Linux executable available for installer download"
          executables_found=true
        fi
        
        if [ -f "macos/dist/StreamerViewer" ]; then
          echo "‚úì macOS executable available for installer download"
          executables_found=true
        fi
        
        if [ "$executables_found" = "true" ]; then
          echo "executables_ready=true" >> $GITHUB_OUTPUT
          echo "üì¶ Executables ready for installer download"
        else
          echo "executables_ready=false" >> $GITHUB_OUTPUT
          echo "‚ùå No executables found for installer download"
        fi

    - name: Commit executables for installer download
      if: steps.check_executables.outputs.executables_ready == 'true'
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add executables for installer download (force add to override .gitignore)
        git add -f windows/dist/StreamerViewer.exe linux/dist/StreamerViewer macos/dist/StreamerViewer
        
        # Commit with build info for installer use
        git commit -m "ü§ñ Update executables for installer download (build ${{ github.run_number }})" \
                   -m "Built from: ${{ github.sha }}" \
                   -m "Branch: ${{ github.ref_name }}" \
                   -m "Purpose: RPI Streamer installer download paths"
        
        # Push to the current branch
        git push origin ${{ github.ref_name }}
        
        echo "‚úÖ Executables committed for installer download at:"
        echo "   ‚Ä¢ windows/dist/StreamerViewer.exe"
        echo "   ‚Ä¢ linux/dist/StreamerViewer" 
        echo "   ‚Ä¢ macos/dist/StreamerViewer"

    - name: Summary
      run: |
        echo "üì¶ Executable commit job completed"
        echo "üéØ Purpose: Make executables available for RPI Streamer installer script"
        echo "üìã Installer download paths:"
        echo "   ‚Ä¢ Windows: https://github.com/tfelici/Streamer-Viewer/raw/${{ github.ref_name }}/windows/dist/StreamerViewer.exe"
        echo "   ‚Ä¢ Linux: https://github.com/tfelici/Streamer-Viewer/raw/${{ github.ref_name }}/linux/dist/StreamerViewer"
        echo "   ‚Ä¢ macOS: https://github.com/tfelici/Streamer-Viewer/raw/${{ github.ref_name }}/macos/dist/StreamerViewer"
        echo "üí° Users can also download from GitHub Actions artifacts for manual use"
