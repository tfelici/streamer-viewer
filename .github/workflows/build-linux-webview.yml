name: Build Linux Viewer with Webview Support

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # Install system dependencies for Qt and GTK GUI libraries
    - name: Install Linux GUI dependencies
      run: |
        sudo apt-get update
        
        # Qt5 system libraries (for PyQt5)
        sudo apt-get install -y \
          qt5-default \
          qtbase5-dev \
          qtwebengine5-dev \
          libqt5webkit5-dev \
          libqt5webenginewidgets5 \
          libqt5webenginecore5 \
          libqt5webengine5 \
          libqt5webengine-data \
          libqt5gui5 \
          libqt5core5a \
          libqt5widgets5 \
          libqt5network5 \
          libqt5printsupport5
        
        # GTK3 system libraries (fallback)
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.0-dev \
          libgirepository1.0-dev \
          gir1.2-gtk-3.0 \
          gir1.2-webkit2-4.0 \
          python3-gi \
          python3-gi-cairo
        
        # Additional GUI dependencies
        sudo apt-get install -y \
          libegl1-mesa \
          libxkbcommon-x11-0 \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libxss1 \
          libasound2 \
          libgconf-2-4 \
          libxrandr2 \
          libatk1.0-0 \
          libgtk-3-0 \
          libgdk-pixbuf2.0-0 \
          libdrm2 \
          libxcomposite1 \
          libxdamage1 \
          libxfixes3 \
          libxss1 \
          libglib2.0-0 \
          libnss3 \
          libxrender1 \
          libx11-xcb1
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        
        # Install core dependencies first
        pip install flask werkzeug jinja2 requests requests-toolbelt
        pip install pyinstaller>=6.0.0
        
        # Install webview and GUI backends
        pip install pywebview>=4.4.0
        
        # Install PyQt5 (preferred for most Linux distributions)
        pip install PyQt5>=5.15.0 PyQt5-tools>=5.15.0 PyQtWebEngine>=5.15.0
        
        # Install GTK backend as fallback
        pip install PyGObject>=3.42.0
        
        # Install media libraries
        pip install pymediainfo
        
        # Install any additional requirements if they exist
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi
        if [ -f "linux/requirements-linux-webview.txt" ]; then
          pip install -r linux/requirements-linux-webview.txt
        fi
    
    - name: Create PyInstaller spec file
      run: |
        cat > StreamerViewer-linux-webview.spec << 'EOF'
        # -*- mode: python ; coding: utf-8 -*-
        
        import sys
        import os
        from PyInstaller.utils.hooks import collect_submodules, collect_data_files
        
        # Collect all webview and Qt related modules
        hiddenimports = [
            # Core webview
            'webview',
            'webview.platforms.qt',
            'webview.platforms.gtk',
            
            # PyQt5 modules
            'PyQt5',
            'PyQt5.QtCore',
            'PyQt5.QtGui', 
            'PyQt5.QtWidgets',
            'PyQt5.QtWebEngineWidgets',
            'PyQt5.QtWebEngine',
            'PyQt5.QtWebEngineCore',
            'PyQt5.QtNetwork',
            'PyQt5.QtPrintSupport',
            'PyQt5.QtQml',
            'PyQt5.QtQuick',
            'PyQt5.QtQuickWidgets',
            'PyQt5.sip',
            
            # GTK modules (fallback)
            'gi',
            'gi.repository',
            'gi.repository.Gtk',
            'gi.repository.WebKit2',
            'gi.repository.GObject',
            'gi.repository.GLib',
            
            # Flask and web server
            'flask',
            'werkzeug',
            'jinja2',
            'requests',
            'requests_toolbelt',
            
            # Other utilities
            'pymediainfo',
            'uuid',
            'threading',
            'json',
            'datetime',
        ]
        
        # Collect data files
        datas = [
            ('templates', 'templates'),
            ('static', 'static'),
        ]
        
        # Try to collect Qt data files
        try:
            import PyQt5
            pyqt5_datas = collect_data_files('PyQt5')
            datas.extend(pyqt5_datas)
        except ImportError:
            pass
        
        a = Analysis(
            ['main.py'],
            pathex=[],
            binaries=[],
            datas=datas,
            hiddenimports=hiddenimports,
            hookspath=[],
            hooksconfig={},
            runtime_hooks=[],
            excludes=[
                # Exclude unnecessary modules to reduce size
                'matplotlib',
                'numpy',
                'scipy',
                'pandas',
                'PIL',
                'cv2',
                'tensorflow',
                'torch',
                'tkinter',
            ],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=None,
            noarchive=False,
        )
        
        # Remove duplicate entries
        pyz = PYZ(a.pure, a.zipped_data, cipher=None)
        
        exe = EXE(
            pyz,
            a.scripts,
            a.binaries,
            a.zipfiles,
            a.datas,
            [],
            name='Viewer-linux',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            upx_exclude=[],
            runtime_tmpdir=None,
            console=False,
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
            icon=None,
        )
        EOF
    
    - name: Build executable with PyInstaller
      run: |
        echo "Building Streamer Viewer with webview support..."
        pyinstaller StreamerViewer-linux-webview.spec --clean --noconfirm
        
        echo "Build complete. Checking output..."
        ls -la dist/
        
        if [ -f "dist/Viewer-linux" ]; then
          echo "✅ Build successful!"
          echo "File size: $(du -h dist/Viewer-linux | cut -f1)"
          
          # Test if the executable can start (basic smoke test)
          echo "Testing executable..."
          timeout 10s ./dist/Viewer-linux --help || echo "Executable appears to work (timeout expected)"
        else
          echo "❌ Build failed - executable not found"
          exit 1
        fi
    
    - name: Upload Linux executable
      uses: actions/upload-artifact@v4
      with:
        name: Viewer-linux-webview
        path: dist/Viewer-linux
        retention-days: 30
    
    - name: Create release info
      run: |
        echo "## Linux Build with Webview Support" > build-info.md
        echo "" >> build-info.md
        echo "Built on: $(date)" >> build-info.md
        echo "Python version: $(python --version)" >> build-info.md
        echo "PyQt5 version: $(python -c 'import PyQt5.QtCore; print(PyQt5.QtCore.PYQT_VERSION_STR)' 2>/dev/null || echo 'Not available')" >> build-info.md
        echo "Webview version: $(python -c 'import webview; print(webview.__version__)' 2>/dev/null || echo 'Not available')" >> build-info.md
        echo "" >> build-info.md
        echo "### Installation Requirements for Target Machine:" >> build-info.md
        echo "" >> build-info.md
        echo "**For KDE/Qt-based desktops:**" >> build-info.md
        echo "\`\`\`bash" >> build-info.md
        echo "sudo apt install qt5-default libqt5webenginewidgets5" >> build-info.md
        echo "\`\`\`" >> build-info.md
        echo "" >> build-info.md
        echo "**For GNOME/GTK-based desktops:**" >> build-info.md
        echo "\`\`\`bash" >> build-info.md
        echo "sudo apt install libgtk-3-0 libwebkit2gtk-4.0-37" >> build-info.md
        echo "\`\`\`" >> build-info.md
        echo "" >> build-info.md
        echo "**Universal (works on most systems):**" >> build-info.md
        echo "\`\`\`bash" >> build-info.md
        echo "sudo apt install qt5-default libgtk-3-0 libwebkit2gtk-4.0-37" >> build-info.md
        echo "\`\`\`" >> build-info.md
        
        cat build-info.md
    
    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: build-info.md
        retention-days: 30