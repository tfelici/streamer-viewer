<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Streamer Viewer</h1>
            <p>GPS Tracks and Video Recordings</p>
        </header>

        <main>
            <div class="section">
                <h2>GPS Tracks</h2>
                {% if tracks %}
                    <div class="track-list">
                        {% for track in tracks %}
                            <div class="track-item">
                                <div class="track-info">
                                    <h3>{{ track.track_id }}</h3>
                                    <div class="track-details">
                                        <span><strong>Created:</strong> {{ track.created | datetimeformat }}</span>
                                        <span><strong>Duration:</strong> {{ track.duration | durationformat }}</span>
                                        <span><strong>Coordinates:</strong> {{ track.coord_count }}</span>
                                        <span><strong>Size:</strong> {{ track.size | filesizeformat }}</span>
                                    </div>
                                </div>
                                <div class="track-actions">
                                    <a href="{{ url_for('view_track', track_id=track.track_id) }}" class="btn btn-primary">View Track</a>
                                    <button class="btn btn-danger" onclick="deleteTrack('{{ track.track_id }}', this)">Delete Track</button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="no-data">No GPS tracks found. Make sure tracks are available in streamerData/tracks/</p>
                {% endif %}
            </div>
        </main>
    </div>

    <script>
        function deleteTrack(trackId, buttonElement) {
            if (!confirm('Are you sure you want to delete this track and its corresponding video? This action cannot be undone.')) {
                return;
            }
            
            // Disable button and show loading state
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'Deleting...';
            buttonElement.disabled = true;
            
            // Send delete request
            fetch('/delete-track', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    track_id: trackId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the track item from the DOM
                    const trackItem = buttonElement.closest('.track-item');
                    trackItem.style.opacity = '0.5';
                    trackItem.style.transition = 'opacity 0.3s ease';
                    
                    setTimeout(() => {
                        trackItem.remove();
                        
                        // Check if there are no tracks left
                        const trackList = document.querySelector('.track-list');
                        if (trackList && trackList.children.length === 0) {
                            const section = document.querySelector('.section');
                            section.innerHTML = '<h2>GPS Tracks</h2><p class="no-data">No GPS tracks found. Make sure tracks are available in streamerData/tracks/</p>';
                        }
                    }, 300);
                    
                    // Show success message
                    showMessage(data.message || 'Track deleted successfully', 'success');
                } else {
                    // Re-enable button on error
                    buttonElement.textContent = originalText;
                    buttonElement.disabled = false;
                    showMessage(data.error || 'Failed to delete track', 'error');
                }
            })
            .catch(error => {
                // Re-enable button on error
                buttonElement.textContent = originalText;
                buttonElement.disabled = false;
                showMessage('Error deleting track: ' + error.message, 'error');
            });
        }
        
        function showMessage(message, type) {
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                border-radius: 4px;
                font-weight: bold;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
                ${type === 'success' ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'}
            `;
            
            document.body.appendChild(messageDiv);
            
            // Fade in
            setTimeout(() => {
                messageDiv.style.opacity = '1';
            }, 10);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
